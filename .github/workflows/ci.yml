name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      FLAGS_SECRET: "KAxoGnNkSfOW8cmVqZ1bV29G1uMp4WXNCEvDWxcWID4"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          # Node 22 can execute our TS runtime test imports used by node:test.
          node-version: 22
          cache: npm

      - name: Install
        run: npm ci

      - name: Check Scripts
        run: npm run check:scripts

      # `npm run build` is safe without NOTION_*; prebuild will skip sync.
      - name: Build
        run: npm run build

      - name: Test
        run: npm test

      # Keep a fast UI gate on PRs: core nav/search/mobile behavior only.
      # Heavier embed/reference checks stay in manual UI Smoke workflow.
      - name: UI Smoke (Quick)
        env:
          SMOKE_UI_QUICK: "1"
          SMOKE_UI_SKIP_BUILD: "1"
        run: npm run smoke:ui

      - name: Accessibility (Axe)
        env:
          A11Y_SKIP_BUILD: "1"
          A11Y_FULL_SITE: "1"
          A11Y_FAIL_ALL: "1"
        run: npm run check:a11y

      - name: Performance Budget
        env:
          PERF_SKIP_BUILD: "1"
          PERF_STRICT: "1"
          PERF_PATHS: "/,/blog,/publications"
          PERF_BUDGET_LCP_MS: "4500"
          PERF_BUDGET_CLS: "0.12"
          PERF_BUDGET_INP_MS: "300"
        run: npm run check:perf

      - name: Upload UI Smoke Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-debug-artifacts
          path: output/ui-smoke/**
          if-no-files-found: ignore

      - name: Upload A11y Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-a11y-artifacts
          path: output/a11y/**
          if-no-files-found: ignore

      - name: Upload Performance Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-perf-artifacts
          path: output/perf/**
          if-no-files-found: ignore
