name: CI

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
  pull_request:
    paths-ignore:
      - "**/*.md"
      - "docs/**"

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      FLAGS_SECRET: ${{ secrets.FLAGS_SECRET }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET != '' && secrets.NEXTAUTH_SECRET || format('ci-nextauth-{0}-{1}', github.run_id, github.run_attempt) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Restore Next.js Build Cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-next-cache-${{ hashFiles('package-lock.json') }}-${{ github.ref_name }}
          restore-keys: |
            ${{ runner.os }}-next-cache-${{ hashFiles('package-lock.json') }}-

      - name: Install
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Detect UI-Impacting Changes (PR)
        if: github.event_name == 'pull_request'
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            ui_quality:
              - "app/**"
              - "components/**"
              - "lib/client/**"
              - "lib/routes/**"
              - "lib/search/**"
              - "lib/publications/**"
              - "lib/load-raw-main.ts"
              - "lib/site-config.ts"
              - "lib/seo/**"
              - "public/**"
              - "scripts/smoke-ui.mjs"
              - "scripts/a11y-check.mjs"
              - "scripts/perf-budget.mjs"
              - "package.json"
              - "package-lock.json"

      - name: Check Scripts
        run: npm run check:scripts

      # `npm run build` is safe without NOTION_*; prebuild will skip sync.
      - name: Build
        run: npm run build

      - name: Test
        run: npm test

      # Keep a fast UI gate on PRs: core nav/search/mobile behavior only.
      # Heavier embed/reference checks stay in manual UI Smoke workflow.
      - name: UI Smoke (Quick)
        if: github.event_name == 'push' || steps.changes.outputs.ui_quality == 'true'
        env:
          SMOKE_UI_QUICK: "1"
          SMOKE_UI_SKIP_BUILD: "1"
        run: npm run smoke:ui

      - name: Accessibility (Axe)
        if: github.event_name == 'push' || steps.changes.outputs.ui_quality == 'true'
        env:
          A11Y_SKIP_BUILD: "1"
          A11Y_FULL_SITE: "1"
          A11Y_FAIL_ALL: "1"
        run: npm run check:a11y

      - name: Performance Budget
        if: github.event_name == 'push' || steps.changes.outputs.ui_quality == 'true'
        env:
          PERF_SKIP_BUILD: "1"
          PERF_STRICT: "1"
          PERF_PATHS: "/,/blog,/publications"
          PERF_BUDGET_LCP_MS: "4500"
          PERF_BUDGET_CLS: "0.12"
          PERF_BUDGET_INP_MS: "300"
        run: npm run check:perf

      - name: Skip UI/A11y/Perf (No UI-Impacting Changes)
        if: github.event_name == 'pull_request' && steps.changes.outputs.ui_quality != 'true'
        run: echo "Skipping UI smoke, a11y, and performance checks for non-UI changes."

      - name: Upload UI Smoke Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-debug-artifacts
          path: output/ui-smoke/**
          if-no-files-found: ignore

      - name: Upload A11y Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-a11y-artifacts
          path: output/a11y/**
          if-no-files-found: ignore

      - name: Upload Performance Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-perf-artifacts
          path: output/perf/**
          if-no-files-found: ignore
